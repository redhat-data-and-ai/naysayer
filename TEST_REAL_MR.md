# Testing Naysayer with Real GitLab MRs

This guide helps you test the naysayer endpoint with real GitLab merge requests, like the one from your example: `https://gitlab.cee.redhat.com/dataverse/dataverse-config/dataproduct-config/-/merge_requests/1764`

## Quick Start

### 1. Set up your GitLab token

```bash
export GITLAB_TOKEN="your_gitlab_token_here"
```

### 2. Start naysayer (if not already running)

```bash
# Option 1: Use the helper script
./test_mr.sh start

# Option 2: Start manually
go run cmd/main.go
```

### 3. Test with a real MR

```bash
# Test with the specific MR you mentioned
./test_mr.sh test https://gitlab.cee.redhat.com/dataverse/dataverse-config/dataproduct-config/-/merge_requests/1764

# Or test with project ID and MR IID (if you know them)
./test_mr.sh test 51 1764
```

## Tools Available

### 1. Shell Script (`test_mr.sh`) - Recommended

This is the easiest way to test:

```bash
# Show help
./test_mr.sh help

# Start naysayer service
./test_mr.sh start

# Test with URL
./test_mr.sh test https://gitlab.cee.redhat.com/dataverse/dataverse-config/dataproduct-config/-/merge_requests/1764

# Test with project ID and MR IID
./test_mr.sh test 51 1764
```

### 2. Go Script (`test_real_mr.go`) - Direct

For more control, use the Go script directly:

```bash
# Test with URL
go run test_real_mr.go https://gitlab.cee.redhat.com/dataverse/dataverse-config/dataproduct-config/-/merge_requests/1764

# Test with project ID and MR IID
go run test_real_mr.go 51 1764
```

## Configuration

Set these environment variables as needed:

```bash
# Required
export GITLAB_TOKEN="your_gitlab_token_here"

# Optional (with defaults)
export NAYSAYER_URL="http://localhost:3000"        # Where naysayer is running
export GITLAB_BASE_URL="https://gitlab.cee.redhat.com"  # GitLab instance
export WRITE_COMMENTS="true"                       # Write test results as MR comments
```

## What the test does

1. **Fetches real MR data** from GitLab API using your token
2. **Creates a webhook payload** that mimics what GitLab would send
3. **Sends the payload** to your running naysayer instance
4. **Shows the response** from naysayer, including:
   - Decision made (approve/manual review)
   - Rules evaluated
   - Execution time
   - Any errors
5. **Writes test results** as a comment on the MR (if `WRITE_COMMENTS=true`)

## Example Output

```
üöÄ Naysayer Real MR Testing Tool
=====================================
üéØ Testing project 51, MR !1764
üîó Naysayer URL: http://localhost:3000
üîó GitLab URL: https://gitlab.cee.redhat.com

üîç Fetching real MR data for project 51, MR !1764...
‚úÖ Successfully fetched MR data: Add new data product configuration for analytics
üì§ Sending webhook payload to naysayer...
üìÑ Webhook payload:
{
  "object_kind": "merge_request",
  "event_type": "merge_request",
  "object_attributes": {
    "iid": 1764,
    "title": "Add new data product configuration for analytics",
    "description": "...",
    "state": "opened",
    "source_branch": "feature/analytics-config",
    "target_branch": "main",
    "action": "open"
  },
  "project": {
    "id": 51,
    "name": "dataproduct-config",
    "path_with_namespace": "dataverse/dataverse-config/dataproduct-config"
  },
  "user": {
    "username": "jdoe",
    "name": "John Doe"
  }
}
üì• Naysayer response status: 200
üìÑ Naysayer response:
{
  "webhook_response": "processed",
  "event_type": "merge_request",
  "decision": {
    "type": "approve",
    "reason": "All validation rules passed"
  },
  "execution_time": "1.2s",
  "rules_evaluated": 5,
  "mr_approved": true,
  "project_id": 51,
  "mr_iid": 1764
}
üí¨ Adding test response comment to MR...
‚úÖ Successfully added test response comment to MR
‚úÖ Successfully tested MR project 51, MR !1764
üéâ Test completed successfully!
```

### MR Comment Example

The script will automatically add a comment to the MR like this:

```markdown
## ü§ñ Naysayer Test Results

*This comment was automatically generated by the naysayer test script.*

### ‚ö†Ô∏è Decision: `manual_review`
**Reason:** Could not fetch MR changes from GitLab API

**Execution Time:** 0s
**Rules Evaluated:** 0
**Status:** Manual review required ‚ö†Ô∏è

---
*Test run by naysayer test script*
```

## Troubleshooting

### "GITLAB_TOKEN not set"
Export your GitLab token:
```bash
export GITLAB_TOKEN="your_token_here"
```

### "Naysayer service is not running"
Start naysayer first:
```bash
go run cmd/main.go
# Or use the helper script
./test_mr.sh start
```

### "Failed to fetch MR data"
- Check that your GitLab token has access to the project
- Verify the MR URL or project ID/MR IID are correct
- Ensure you can access the GitLab instance

### "GitLab API returned status 404"
- The MR might not exist or might be private
- Check the project ID and MR IID are correct
- Verify your token has access to the repository

## Testing Different Scenarios

You can test various scenarios by:

1. **Testing different MRs** - Use different project IDs or MR IIDs
2. **Controlling comments** - Set `WRITE_COMMENTS=false` to test without writing to MR:
   ```bash
   export WRITE_COMMENTS=false
   ./test_mr.sh test <mr_url>
   ```
3. **Modifying the webhook action** - Edit `test_real_mr.go` and change the `action` field to:
   - `"open"` - New MR
   - `"update"` - MR updated
   - `"reopen"` - MR reopened
   - `"close"` - MR closed
   - `"merge"` - MR merged

4. **Testing error conditions** - Use invalid project IDs or MR IIDs to test error handling

## Next Steps

Once you've verified the endpoint works with real MRs, you can:

1. Set up GitLab webhooks to point to your naysayer instance
2. Configure the webhook secret for security
3. Deploy naysayer to your production environment
4. Monitor the logs and responses for any issues
